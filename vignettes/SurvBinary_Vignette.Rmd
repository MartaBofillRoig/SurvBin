---
title: "R Code - A general class of two-sample statistics for binary and  time-to-event outcomes"
author: "Marta Bofill Roig^[[marta.bofill.roig@upc.edu](marta.bofill.roig@upc.edu)], Guadalupe Gomez Melis^[[lupe.gomez@upc.edu](lupe.gomez@upc.edu)]"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    base_format: rmarkdown::html_vignette
    toc: true
    number_sections: false
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = F}
knitr::opts_chunk$set(
  collapse = T,
  comment = "#>"
)
knitr::opts_chunk$set(echo = TRUE) 
``` 


This report describes the R Code for the preprint *A general class of two-sample statistics for binary and  time-to-event outcomes*. Available at: [https://arxiv.org/abs/2002.01369](https://arxiv.org/abs/2002.01369)

## Prelude 

Package dependences:
```{r,warning=F}
library(survival)
library(zoo)
library(muhaz)
library(copula)
library(devtools)
install_github("MartaBofillRoig/SurvBin")
```

## Functions 

### L-statistics

Function `lstats()`: performs a L-statistic for right-censored and binary data.

Arguments:

  - time: The observed time.
  - status: The status indicator, normally 0=alive, 1=dead. 
  - binary: 0=nonresponse, 1=response. 
  - treat: The treatment-group indicator, normally 0=control, 1=intervention.
  - tau: follow-up. Default NULL denoting the last time in which both groups had patients at risk.
  - taub parameter: time-point at which binary endpoint is evaluated. If NULL, the binary endpoint is evaluated at tau.
  - rho: A scalar parameter that controls the type of test (see Details).
  - gamma: A scalar parameter that controls the type of test (see Details).
  - eta: A scalar parameter that controls the type of test (see Details).
  - gamma: A scalar parameter that controls the type of test (see Details).
  - var_est: indicates the variance estimate to use ('Pooled' or 'Unpooled').

Details:

Th L-statistics are defined as a weighted linear combination of the difference of proportions statistic for the binary outcome
and the integrated weighted difference of two survival functions for the time-to-event outcome, 
as follows, 
\begin{equation} \label{Lclass}
	%	\mathrm{\textbf{U}}_{n}^{\omega_b,\omega_s,\hat{Q}}(\tau_0,\tau_b,\tau)=
	\mathrm{\textbf{U}}_{n}^{\omega}(\tau_0,\tau_b,\tau; \hat{Q})
	=  {\omega}_b \cdot \frac{U_{b,n}\left(\tau_b\right)}{\hat{\sigma}_b}  
	+  {\omega}_s \cdot \frac{U_{s,n}(\tau_0,\tau;\hat{Q})}{\hat{\sigma}_s} 
\end{equation}

for some real numbers $\omega_b,\omega_s\in (0,1)$, such that  $\omega_b+\omega_s=1$, and where: 
\begin{eqnarray} 
	U_{b,n}\left(\tau_b\right) &=& \sqrt{\frac{n^{(0)}n^{(1)}}{n}} \left(\hat{p}^{(1)}\left(\tau_b\right)  -  \hat{p}^{(0)}\left(\tau_b\right)\right) \\ 
	U_{s,n}(\tau_0,\tau;\hat{Q}) &=& 
	\sqrt{\frac{n^{(0)}n^{(1)}}{n}}\left( \int_{\tau_0}^{\tau} \hat{Q}(t) \cdot\left( \hat{S}^{(1)}(t)-\hat{S}^{(0)}(t)\right)  dt \right) 
\end{eqnarray}
representing by $\hat{\sigma}_b^2$ and $\hat{\sigma}_s^2$ the estimated variances of $U_{b,n}\left(\tau_b\right)$ and $U_{s,n}(\tau_0,\tau;\hat{Q})$, respectively; and 
denoting by $\hat{p}^{(i)}(\tau_b)$ the estimated proportion of events $\varepsilon_b$ before  $\tau_b$, and by $\hat{S}^{(i)}(\cdot)$ the  Kaplan-Meier estimator of $S^{(i)}(\cdot)$. 

The term $\hat{Q}(\cdot)$  is a random function defined as:
\begin{equation}  
	\hat{Q}(t) = \hat{w}^{(i)}(t)^\eta \cdot (\hat{S}^{(i)}(t))^\rho \cdot (1-\hat{S}^{(i)}(t))^\gamma
\end{equation} 
for $\eta,\rho,\gamma\geq0$, and where:
$$\hat{w}(t) = \frac{n\hat{C}^{(0)}(t-)\hat{C}^{(1)}(t-)}{n^{(0)}\hat{C}^{(0)}(t-)+n^{(1)}\hat{C}^{(1)}(t-)}$$
is the weight proposed by Pepe-Fleming (Biometrics ,1989). 

More details can be found in the corresponding pre-print [Link](https://arxiv.org/abs/2002.01369).

### Binary statistic 

Function `bintest()`: performs a test for testing the null hypothesis that the proportions (probabilities of success) in two groups are the same.

Arguments:

- binary: 0=nonresponse, 1=response. 
- treat: The treatment-group indicator, normally 0=control, 1=intervention.
- var_est: indicates the variance estimate to use ('Pooled' or 'Unpooled').

Details:

The statistic used is:
\begin{eqnarray} 
	\frac{U_{b,n}\left(\tau_b\right)}{\hat{\sigma}_b} &=& \frac{\sqrt{\frac{n^{(0)}n^{(1)}}{n}} \left(\hat{p}^{(1)}\left(\tau_b\right)  -  \hat{p}^{(0)}\left(\tau_b\right)\right)}{\sqrt{\hat{p}(\tau_b)\cdot\left( 1-\hat{p}(\tau_b)\right)}} 
\end{eqnarray} 

More details can be found in the corresponding pre-print [Link](https://arxiv.org/abs/2002.01369).

### Time-to-event statistic 

Function `survtest()`: performs a test for right-censored data. It uses the Weighted Kaplan-Meier family of statistics for testing the differences of two survival curves.

Arguments:

- time: The observed time.
- status: The status indicator, normally 0=alive, 1=dead. 
- treat: The treatment-group indicator, normally 0=control, 1=intervention.
- tau: follow-up. Default NULL denoting the last time in which both groups had patients at risk.
- rho: A scalar parameter that controls the type of test (see Weights).
- gamma: A scalar parameter that controls the type of test (see Weights).
- var_est: indicates the variance estimate to use ('Pooled' or 'Unpooled').

Details:

The statistic used is:
\begin{eqnarray}  
	\frac{U_{s,n}(\tau_0,\tau;\hat{Q})}{\hat{\sigma}_s} &=& \frac{\sqrt{\frac{n^{(0)}n^{(1)}}{n}}\left( \int_{\tau_0}^{\tau} \hat{Q}(t) \cdot\left( \hat{S}^{(1)}(t)-\hat{S}^{(0)}(t)\right)  dt \right)}{\sqrt{-  \int_{\tau_0}^{\tau} \frac{\left(\int_{t}^{\tau} \hat{Q}(u)\hat{S}(u) du \right)^2 }{\hat{S}(t)\hat{S}(t-) }\cdot \frac{n^{(0)}\hat{C}^{(0)}(t-)+n^{(1)}\hat{C}^{(1)}(t-)}{n\hat{C}^{(0)}(t-)\hat{C}^{(1)}(t-)} d\hat{S}(t)}} 
\end{eqnarray} 
For more information on the weight function $\hat{Q}(t)$, see Details in  function `lstats()`.



### Covariance

Functions `survbinCov()` and `survbinCov_kernel()`: compute the covariance between the binary and time-to-event statistics. 

Arguments:

  - time: The observed time.
  - status: The status indicator, normally 0=alive, 1=dead. 
  - binary: 0=nonresponse, 1=response. 
  - treat: The treatment-group indicator, normally 0=control, 1=intervention.
  - tau: follow-up. Default NULL denoting the last time in which both groups had patients at risk.
  - taub parameter: time-point at which binary endpoint is evaluated. If NULL, the binary endpoint is evaluated at tau.
  - rho: A scalar parameter that controls the type of test (see Details in function `lstats()`).
  - gamma: A scalar parameter that controls the type of test (see Details in function `lstats()`).
  - eta: A scalar parameter that controls the type of test (see Details in function `lstats()`).
  - gamma: A scalar parameter that controls the type of test (see Details in function `lstats()`).
  - var_est: indicates the variance estimate to use ('Pooled' or 'Unpooled').

Details:

These functions return an estimation of $\mathrm{Cov}(U_{b,n}, U_{s,n}(Q))$ given by:

\begin{eqnarray*}  
		\hat{Cov}  &=&  
		-  \int_{\tau_0}^{\tau_b} \hspace{-1mm} \hat{K}_{\tau_b}(t) 
		\left( 
		\sum_{i=0,1} \hspace{-1mm}\frac{n-n^{(i)}}{n} \cdot \hat{\lambda}_{X,T}^{(i)}(t)dt+ \frac{\hat{p}\left(\tau_b\right) \cdot d\hat{S}(t) }{\hat{S}(t)} \right)  
		\nonumber\\
		&& +  \int_{\tau_b}^{\tau}  
		\frac{\hat{K}_{\tau}(t) \cdot\hat{p}\left(\tau_b\right)}{\hat{S}(t-) }  \left( - \frac{\hat{S}(t-) \cdot d\hat{S}(t)}{\hat{S}(t)} 
		+ \sum_{i=0,1} \frac{n-n^{(i)}}{n} \cdot \frac{\hat{S}_X^{(i)}(t-)\cdot d\hat{S}_X^{(i)}(t)}{\hat{S}_X^{(i)}(t)} 
		\right)  
\end{eqnarray*}  
where the hazard functions $\hat{\lambda}_{X,T}^{(i)}(t)$  is the estimator of 	$\lambda_{X,T}^{(i)}(t) = \lim_{dt\rightarrow0} P(X_{ij}=1, t\leq T_{ij} < t +dt |T_{ij}>t)/dt$ and  is computed by means of kernel smoothing methods (`R` package `muhaz`).

More details can be found in the corresponding pre-print [Link](https://arxiv.org/abs/2002.01369).

